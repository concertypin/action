name: "Show Coverage Report"
description: "Create GitHub commit status with Vitest coverage metrics (lines, statements, functions, branches)"
author: "concertypin"

inputs:
  json-file:
    description: "Path to coverage report JSON (generated with --coverage.reporter=json-summary)"
    default: "./coverage/coverage-summary.json"
    required: false
  threshold:
    description: "Minimum threshold for line coverage percentage (any number)"
    default: "75"
    required: false
  title:
    description: "Title for report"
    default: "Vitest Coverage"
    required: false

runs:
  using: "composite"
  steps:
    - name: Update Coverage Status
      uses: actions/github-script@v7
      env:
        JSON_PATH: ${{ inputs.json-file }}
        THRESHOLD: ${{ inputs.threshold }}
        TITLE: ${{ inputs.title }}
      with:
        script: |
          try {
            const fs = require('fs');
            const jsonPath = process.env.JSON_PATH;
            
            function toFloat(i) {
              const num = typeof i === "number" ? i : parseFloat(i);
              if (isNaN(num)) {
                throw new Error(`Invalid number: ${i}`);
              }
              return parseFloat(num.toFixed(2));
            }

            // Validate threshold
            const threshold = parseFloat(process.env.THRESHOLD);
            if (isNaN(threshold)) {
              core.setFailed(`Invalid threshold: "${process.env.THRESHOLD}". Must be a valid number.`);
              return;
            }

            // Check if coverage file exists
            if (!fs.existsSync(jsonPath)) {
              core.setFailed(`Coverage file not found: ${jsonPath}`);
              return;
            }

            // Parse coverage summary
            const summary = JSON.parse(fs.readFileSync(jsonPath, 'utf8'));
            const { lines, statements, functions, branches } = summary.total;

            // Format coverage percentages
            const lineCoverage = toFloat(lines.pct);
            const statCoverage = toFloat(statements.pct);
            const funcCoverage = toFloat(functions.pct);
            const branchCoverage = toFloat(branches.pct);
            const thresholdDisplay = toFloat(threshold);

            // Determine status
            const isSuccess = lineCoverage >= threshold;
            const state = isSuccess ? 'success' : 'failure';

            // Format description
            const description = `Lines: ${lineCoverage}% | Statements: ${statCoverage}% | Functions: ${funcCoverage}% | Branches: ${branchCoverage}% (Threshold: ${thresholdDisplay}%)`;
            
            const target_url = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            // Create commit status
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: state,
              context: process.env.TITLE || 'Vitest Coverage',
              description: description,
              target_url
            });

            core.info(`Coverage check completed: ${state} (${lineCoverage}% coverage)`);
          } catch (error) {
            core.setFailed(`Error processing coverage report: ${error?.message ?? String(error)}`);
          }